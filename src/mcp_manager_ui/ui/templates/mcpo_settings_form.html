<!-- src/mcp_manager_ui/ui/templates/mcpo_settings_form.html -->
<!-- ================================================ -->
<!-- FILE: src/mcp_manager_ui/ui/templates/mcpo_settings_form.html -->
<!-- (Улучшенный дизайн и выравнивание) -->
<!-- ================================================ -->
{% extends "base.html" %}

{% block title %}Настройки MCPO - MCP Менеджер{% endblock %}
{% block page_title %}Настройки MCPO{% endblock %}
{% block page_subtitle %}Конфигурация параметров запуска сервера mcpo и интерфейса менеджера{% endblock %}

{% block head_extra %}
<style>
    /* Улучшение вертикального выравнивания для switch рядом с input */
    .input-field-with-switch {
        display: flex;
        align-items: center; /* Выравниваем по центру */
        flex-wrap: wrap; /* Позволяем перенос на мобильных */
    }
    .input-field-with-switch .input-part {
        flex-grow: 1; /* Занимает доступное пространство */
        min-width: 200px; /* Минимальная ширина для поля ввода */
        margin-right: 20px; /* Отступ от переключателя */
    }
    .input-field-with-switch .switch-part {
        flex-shrink: 0; /* Не сжимаем переключатель */
        margin-top: 15px; /* Небольшой отступ сверху для выравнивания с input */
    }

    /* Выравнивание для главного переключателя (Health Check Enable) */
     .main-switch-row {
        display: flex;
        align-items: center;
        margin-bottom: 15px; /* Отступ снизу */
     }
     .main-switch-row .switch {
        margin-right: 15px;
     }
      .main-switch-row p.caption {
         margin-top: 0;
         margin-bottom: 0;
         flex-grow: 1;
      }

    /* Уменьшение отступа снизу для .row внутри карточек */
    .card-content .row {
        margin-bottom: 10px;
    }
     .card-content .row:last-child {
        margin-bottom: 0;
    }
    /* Доп. отступ для helper-text, чтобы он не прилипал */
    .input-field .helper-text {
        margin-top: 2px;
    }
    /* Стили для инфо-блока в Health Check */
    .health-check-info {
        margin-top: 20px;
        padding: 10px 12px;
        background-color: rgba(0,0,0, 0.1);
        border-radius: 3px;
        border-left: 3px solid #607d8b; /* Акцент */
        font-size: 0.85rem;
    }
     .health-check-info i {
        vertical-align: middle;
        margin-right: 5px;
        font-size: 1.1em;
     }
     .health-check-info code {
         background-color: rgba(255, 255, 255, 0.1);
         padding: 1px 4px;
         border-radius: 2px;
         font-size: 1em; /* Немного больше */
     }
</style>
{% endblock %}


{% block content %}

{% if error %}
<div class="card-panel red lighten-3 black-text">
    <strong><i class="material-icons left tiny">error_outline</i>Ошибка:</strong> {{ error }}
</div>
{% endif %}

{% if success %}
<div class="card-panel green lighten-3 black-text">
    <strong><i class="material-icons left tiny">check_circle_outline</i>Успешно:</strong> {{ success }}
</div>
{% endif %}

<div class="row">
    <form class="col s12" method="post" action="{{ url_for('ui_update_mcpo_settings') }}">
        <!-- Основные настройки MCPO -->
        <div class="card">
            <div class="card-content">
                <span class="card-title grey-text text-darken-1" style="margin-bottom: 20px;">Основные настройки MCPO</span>
                <div class="row">
                    <div class="input-field col s12 m6">
                        <i class="material-icons prefix">settings_input_antenna</i>
                        <input type="number" id="port" name="port" value="{{ settings.port if settings else 8000 }}" required min="1024" max="65535" class="validate">
                        <label for="port">Порт MCPO (локальный)</label>
                        <span class="helper-text">Порт для запуска сервера mcpo на этой машине (1024-65535).</span>
                    </div>
                    <div class="input-field col s12 m6">
                        <i class="material-icons prefix">public</i>
                        <input type="url" id="public_base_url" name="public_base_url" value="{{ settings.public_base_url if settings and settings.public_base_url is not none else '' }}" placeholder="Напр., http://your.domain.com:8000">
                        <label for="public_base_url">Публичный базовый URL (опционально)</label>
                        <span class="helper-text">URL для внешних ссылок. Если пусто, используется http://127.0.0.1:PORT.</span>
                    </div>
                </div>
                {# API Key + Switch #}
                <div class="row input-field-with-switch">
                     <div class="input-field input-part col s12 m8"> {# Используем m8 для поля ввода #}
                        <i class="material-icons prefix">key</i>
                        <input type="text" id="api_key" name="api_key" value="{{ settings.api_key if settings and settings.api_key is not none else '' }}">
                        <label for="api_key">API Ключ MCPO (опционально)</label>
                         <span class="helper-text">Ключ для защиты эндпоинтов (Bearer token).</span>
                    </div>
                    <div class="switch-part col s12 m4"> {# Используем m4 для переключателя #}
                         <div class="switch">
                            <label>
                                Выкл.
                                <input type="checkbox" id="use_api_key" name="use_api_key" value="true" {% if settings and settings.use_api_key %}checked{% endif %}>
                                <span class="lever"></span>
                                Вкл. API ключ
                            </label>
                        </div>
                    </div>
                </div>
                {# Config File Path #}
                <div class="row">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">description</i>
                        <input type="text" id="config_file_path" name="config_file_path" value="{{ settings.config_file_path if settings else 'mcp_generated_config.json' }}" required class="validate">
                        <label for="config_file_path">Путь к файлу конфигурации MCPO</label>
                        <span class="helper-text">Файл, который будет генерироваться для запуска mcpo.</span>
                    </div>
                </div>
                 {# Log File Path #}
                 <div class="row">
                    <div class="input-field col s12">
                        <i class="material-icons prefix">assignment</i>
                        <input type="text" id="log_file_path" name="log_file_path" value="{{ settings.log_file_path if settings and settings.log_file_path is not none else '' }}">
                        <label for="log_file_path">Путь к лог-файлу MCPO (опционально)</label>
                        <span class="helper-text">Файл для записи логов процесса mcpo. Если пусто, логи идут в stdout/stderr.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Настройки отображения логов -->
        <div class="card" style="margin-top: 20px;">
             <div class="card-content">
                <span class="card-title grey-text text-darken-1" style="margin-bottom: 20px;">Отображение логов в Менеджере</span>
                 {# Log Refresh Interval + Switch #}
                 <div class="row input-field-with-switch">
                    <div class="input-field input-part col s12 m7"> {# Используем m7 для поля ввода #}
                        <i class="material-icons prefix">timer</i>
                        <input type="number" id="log_auto_refresh_interval_seconds" name="log_auto_refresh_interval_seconds"
                               value="{{ settings.log_auto_refresh_interval_seconds if settings else 180 }}"
                               required min="5" max="3600" class="validate">
                        <label for="log_auto_refresh_interval_seconds">Интервал автообновления (сек)</label>
                        <span class="helper-text">Как часто обновлять логи на странице логов (5-3600 сек).</span>
                    </div>
                     <div class="switch-part col s12 m5"> {# Используем m5 для переключателя #}
                         <div class="switch">
                            <label>
                                Автообновление выкл.
                                <input type="checkbox" id="log_auto_refresh_enabled" name="log_auto_refresh_enabled"
                                       value="true" {% if settings and settings.log_auto_refresh_enabled %}checked{% endif %}>
                                <span class="lever"></span>
                                Автообновление вкл.
                            </label>
                        </div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Настройки Health Check -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-content">
                <span class="card-title grey-text text-darken-1" style="margin-bottom: 20px;">Проверка работоспособности и Авто-рестарт MCPO</span>
                 {# Main Health Check Enable Switch + Description #}
                 <div class="row main-switch-row">
                     <div class="switch">
                        <label>
                            Выкл.
                            <input type="checkbox" id="health_check_enabled" name="health_check_enabled"
                                   value="true" {% if settings and settings.health_check_enabled %}checked{% endif %}>
                            <span class="lever"></span>
                            Вкл.
                        </label>
                    </div>
                     <p class="caption grey-text text-darken-1">
                         Включить периодическую проверку доступности MCPO через эхо-запрос.
                     </p>
                </div>
                {# Interval + Failure Attempts #}
                <div class="row">
                    <div class="input-field col s12 m6">
                        <i class="material-icons prefix">timer</i>
                        <input type="number" id="health_check_interval_seconds" name="health_check_interval_seconds"
                               value="{{ settings.health_check_interval_seconds if settings else 10 }}"
                               required min="5" class="validate">
                        <label for="health_check_interval_seconds">Интервал проверки (сек)</label>
                        <span class="helper-text">Частота проверок при успехе (минимум 5 сек).</span>
                    </div>
                    <div class="input-field col s12 m6">
                        <i class="material-icons prefix">error_outline</i> {# Иконка изменена #}
                        <input type="number" id="health_check_failure_attempts" name="health_check_failure_attempts"
                               value="{{ settings.health_check_failure_attempts if settings else 3 }}"
                               required min="1" class="validate">
                        <label for="health_check_failure_attempts">Попыток перед рестартом</label>
                        <span class="helper-text">Неудач подряд перед рестартом (минимум 1).</span>
                    </div>
                </div>
                {# Failure Delay + Auto-Restart Switch #}
                <div class="row input-field-with-switch">
                    <div class="input-field input-part col s12 m7"> {# Используем m7 для поля ввода #}
                        <i class="material-icons prefix">replay</i> {# Иконка изменена #}
                        <input type="number" id="health_check_failure_retry_delay_seconds" name="health_check_failure_retry_delay_seconds"
                               value="{{ settings.health_check_failure_retry_delay_seconds if settings else 5 }}"
                               required min="1" class="validate">
                        <label for="health_check_failure_retry_delay_seconds">Задержка при неудаче (сек)</label>
                        <span class="helper-text">Пауза между неудачными проверками (минимум 1 сек).</span>
                    </div>
                     <div class="switch-part col s12 m5"> {# Используем m5 для переключателя #}
                         <div class="switch">
                            <label>
                                Рестарт выкл.
                                <input type="checkbox" id="auto_restart_on_failure" name="auto_restart_on_failure"
                                       value="true" {% if settings and settings.auto_restart_on_failure %}checked{% endif %}>
                                <span class="lever"></span>
                                Авто-рестарт вкл.
                            </label>
                        </div>
                         {# Маленькое описание можно добавить здесь или оставить как есть #}
                         <p class="caption grey-text text-darken-1" style="font-size:0.8rem; margin-top: 5px;">
                             Перезапускать mcpo при сбое проверок.
                         </p>
                    </div>
                </div>
                {# Info Block #}
                <div class="health-check-info grey-text text-lighten-1">
                    <i class="material-icons tiny">info_outline</i>
                    <span>Для проверки используется встроенный эхо-сервер <code>{{ settings.INTERNAL_ECHO_SERVER_NAME }}</code>. Он добавляется в конфигурацию, если проверка включена. Команда: <code>{{ settings.INTERNAL_ECHO_SERVER_COMMAND }} {{ ' '.join(settings.INTERNAL_ECHO_SERVER_ARGS) }}</code>.</span>
                </div>
            </div>
        </div>

        <!-- Кнопки Сохранить/Отмена -->
        <div class="row" style="margin-top: 30px;">
            <div class="col s12">
                 <button class="btn waves-effect waves-light blue darken-1" type="submit" style="margin-right: 10px;">
                     <i class="material-icons left">save</i>Сохранить все настройки
                 </button>
                 <a href="{{ url_for('ui_root') }}" class="btn waves-effect waves-light grey lighten-1 black-text">
                      <i class="material-icons left">cancel</i>Отмена
                 </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{# Можно добавить JS для динамического вкл/выкл полей HealthCheck при изменении главного свитча #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация Materialize компонентов (если нужны, например, Select)
    // M.FormSelect.init(document.querySelectorAll('select'));

    // Пример: Динамическое вкл/выкл полей Health Check
    const healthCheckEnabledSwitch = document.getElementById('health_check_enabled');
    const healthCheckFields = [
        document.getElementById('health_check_interval_seconds'),
        document.getElementById('health_check_failure_attempts'),
        document.getElementById('health_check_failure_retry_delay_seconds'),
        document.getElementById('auto_restart_on_failure')
    ];

    function toggleHealthCheckFields() {
        const isDisabled = !healthCheckEnabledSwitch.checked;
        healthCheckFields.forEach(field => {
            if (field) {
                field.disabled = isDisabled;
                // Дополнительно можно добавить/удалить класс для визуального отображения неактивности
                const parentWrapper = field.closest('.input-field') || field.closest('.switch-part');
                 if (parentWrapper) {
                     parentWrapper.style.opacity = isDisabled ? 0.6 : 1;
                 }
                 // Для switch нужно также дизейблить сам input внутри label
                 if (field.type === 'checkbox' && field.parentNode.classList.contains('switch')) {
                     const switchInput = field.parentNode.querySelector('input[type="checkbox"]');
                     if(switchInput) switchInput.disabled = isDisabled;
                 }
            }
        });
         // Обновление состояния Materialize (если бы были Select или другие компоненты)
         // M.updateTextFields();
    }

    if (healthCheckEnabledSwitch) {
        healthCheckEnabledSwitch.addEventListener('change', toggleHealthCheckFields);
        // Первоначальная установка состояния при загрузке страницы
        toggleHealthCheckFields();
    }

    // --- Аналогично можно сделать для API Key ---
    const useApiKeySwitch = document.getElementById('use_api_key');
    const apiKeyInput = document.getElementById('api_key');

    function toggleApiKeyInput() {
        if (apiKeyInput) {
            apiKeyInput.disabled = !useApiKeySwitch.checked;
            const parentWrapper = apiKeyInput.closest('.input-field');
            if (parentWrapper) {
                 parentWrapper.style.opacity = apiKeyInput.disabled ? 0.6 : 1;
             }
        }
    }

     if (useApiKeySwitch) {
        useApiKeySwitch.addEventListener('change', toggleApiKeyInput);
        toggleApiKeyInput(); // Initial state
    }

     // --- Аналогично для Log Auto Refresh ---
     const logRefreshEnabledSwitch = document.getElementById('log_auto_refresh_enabled');
     const logRefreshIntervalInput = document.getElementById('log_auto_refresh_interval_seconds');

     function toggleLogRefreshInput() {
         if (logRefreshIntervalInput) {
             logRefreshIntervalInput.disabled = !logRefreshEnabledSwitch.checked;
              const parentWrapper = logRefreshIntervalInput.closest('.input-field');
              if (parentWrapper) {
                 parentWrapper.style.opacity = logRefreshIntervalInput.disabled ? 0.6 : 1;
             }
         }
     }

      if (logRefreshEnabledSwitch) {
        logRefreshEnabledSwitch.addEventListener('change', toggleLogRefreshInput);
        toggleLogRefreshInput(); // Initial state
    }

});
</script>
{% endblock %}