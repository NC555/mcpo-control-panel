<!-- ================================================ -->
<!-- FILE: src/mcp_manager_ui/ui/templates/logs.html  -->
<!-- (Новый файл для страницы логов)                -->
<!-- ================================================ -->
{% extends "base.html" %}

{% block title %}Логи MCPO - MCP Менеджер{% endblock %}
{% block page_title %}Логи процесса MCPO{% endblock %}
{% block page_subtitle %}Просмотр последних записей из лог-файла mcpo{% endblock %}

{% block content %}
<div class="row">
    <div class="col s12">
        <div class="card">
            <div class="card-content">
                <span class="card-title">Логи</span>
                {% if not mcpo_settings.log_file_path %}
                <p class="orange-text text-darken-2">
                    <i class="material-icons left tiny">warning</i>
                    Путь к файлу логов MCPO не указан в <a href="{{ url_for('ui_edit_mcpo_settings_form') }}">настройках</a>.
                </p>
                {% elif not log_file_path_exists %}
                 <p class="orange-text text-darken-2">
                    <i class="material-icons left tiny">warning</i>
                    Файл логов MCPO не найден по указанному пути: <code>{{ mcpo_settings.log_file_path }}</code>.
                    Проверьте <a href="{{ url_for('ui_edit_mcpo_settings_form') }}">настройки</a> или убедитесь, что процесс mcpo был запущен и создал лог-файл.
                </p>
                {% else %}
                <div style="margin-bottom: 15px;">
                    <span class="grey-text text-darken-1">Путь к файлу: <code>{{ mcpo_settings.log_file_path }}</code></span>
                    <div class="switch right" style="padding-top: 5px;">
                        <label>
                            Автообновление выкл.
                            <input type="checkbox" id="log-auto-refresh-toggle"
                                   {% if mcpo_settings.log_auto_refresh_enabled %}checked{% endif %}
                                   onchange="toggleLogAutoRefresh(this.checked)">
                            <span class="lever"></span>
                            Автообновление вкл.
                        </label>
                    </div>
                </div>

                <div id="mcpo-logs-container"
                     style="max-height: 60vh; overflow-y: auto; background-color: #263238; color: #eceff1; padding: 15px; border-radius: 4px; font-family: 'Courier New', Courier, monospace; font-size: 0.9em;"
                     hx-get="{{ url_for('get_mcpo_process_logs_html') }}?lines=100" {# Загружаем больше строк по умолчанию #}
                     hx-swap="innerHTML"
                     {% if mcpo_settings.log_auto_refresh_enabled %}
                        hx-trigger="load, every {{ mcpo_settings.log_auto_refresh_interval_seconds }}s"
                     {% else %}
                        hx-trigger="load"
                     {% endif %}
                     >
                    <p class="grey-text text-lighten-2">Загрузка логов...</p>
                </div>
                 <button class="btn-small waves-effect waves-light blue-grey lighten-1"
                        style="margin-top: 15px;"
                        hx-get="{{ url_for('get_mcpo_process_logs_html') }}?lines=100"
                        hx-target="#mcpo-logs-container"
                        hx-swap="innerHTML"
                        hx-indicator="#log-refresh-spinner">
                    <i class="material-icons left">refresh</i>Обновить сейчас
                </button>
                <div id="log-refresh-spinner" class="htmx-indicator preloader-wrapper tiny active" style="vertical-align: middle; margin-left: 10px; width: 18px; height: 18px;">
                    <div class="spinner-layer spinner-blue-only">
                        <div class="circle-clipper left"><div class="circle"></div></div>
                        <div class="gap-patch"><div class="circle"></div></div>
                        <div class="circle-clipper right"><div class="circle"></div></div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    function toggleLogAutoRefresh(enabled) {
        const logsContainer = document.getElementById('mcpo-logs-container');
        if (!logsContainer) return;

        // Чтобы изменение настройки автообновления сохранилось,
        // нужно отправить запрос на сервер для обновления McpoSettings.
        // Сейчас мы просто меняем поведение на клиенте.
        // Для сохранения нужно было бы добавить hx-post на чекбокс
        // и обработчик на сервере.

        if (enabled) {
            const interval = {{ mcpo_settings.log_auto_refresh_interval_seconds }}; // Берем из настроек
            logsContainer.setAttribute('hx-trigger', `load, every ${interval}s`);
            // Форсируем перезагрузку триггеров HTMX для этого элемента
            htmx.process(logsContainer);
             M.toast({html: `Автообновление логов включено (каждые ${interval} сек.)`, classes: 'green lighten-1'});
        } else {
            logsContainer.setAttribute('hx-trigger', 'load'); // Только при загрузке страницы
            htmx.process(logsContainer);
            M.toast({html: 'Автообновление логов выключено', classes: 'orange darken-1'});
        }
        // Важно: чтобы это изменение сохранялось между перезагрузками страницы,
        // значение чекбокса и интервал должны сохраняться в McpoSettings на сервере.
        // Сейчас `onchange` влияет только на текущую сессию в браузере.
        // Для персистентности: чекбокс должен через hx-post обновлять McpoSettings.
    }

    // При загрузке страницы, если автообновление включено, убедимся, что триггер установлен.
    // Это уже делается через Jinja в hx-trigger.
</script>
{% endblock %}